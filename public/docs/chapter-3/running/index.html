<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/pokerl/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=pokerl/livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  Actually Building the RL System
  #

So I have a policy, observations, an environment and a reward. Now it&rsquo;s time to discuss the meat of the system and how I wrote it. Along the way, I&rsquo;ll provide relevant snippets of code and tricks I did to make my system run as fast as possible.
Before I begin though, I am obligated to give thanks to Joseph Suarez, the creator of PufferAI and PufferLib. Joseph graciously donated 4 machines to this effort. Each machine contained a NVIDIA 4090 GPU, Intel Core i9-14900K, 125 GB of RAM and 2TB of disk space. Before his contribution, I was paying $200/month using vast.ai for training with worse hardware.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/pokerl/docs/chapter-3/running/">
  <meta property="og:site_name" content="Pokémon RL">
  <meta property="og:title" content="Running">
  <meta property="og:description" content="Actually Building the RL System # So I have a policy, observations, an environment and a reward. Now it’s time to discuss the meat of the system and how I wrote it. Along the way, I’ll provide relevant snippets of code and tricks I did to make my system run as fast as possible.
Before I begin though, I am obligated to give thanks to Joseph Suarez, the creator of PufferAI and PufferLib. Joseph graciously donated 4 machines to this effort. Each machine contained a NVIDIA 4090 GPU, Intel Core i9-14900K, 125 GB of RAM and 2TB of disk space. Before his contribution, I was paying $200/month using vast.ai for training with worse hardware.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>Running | Pokémon RL</title>
<link rel="icon" href="/pokerl/favicon.png" >
<link rel="manifest" href="/pokerl/manifest.json">
<link rel="canonical" href="http://localhost:1313/pokerl/docs/chapter-3/running/">
<link rel="stylesheet" href="/pokerl/book.min.20566c4d69204c7b44949aa70a954a16ae963f6de14a8871d403b3c690ffd867.css" integrity="sha256-IFZsTWkgTHtElJqnCpVKFq6WP23hSohx1AOzxpD/2Gc=" crossorigin="anonymous">
  <script defer src="/pokerl/fuse.min.js"></script>
  <script defer src="/pokerl/en.search.min.d74caf9e1f37654616fc5cd17d34e8f594f7ef9b66d47cc5300f616d0a8ac500.js" integrity="sha256-10yvnh83ZUYW/FzRfTTo9ZT375tm1HzFMA9hbQqKxQA=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/pokerl/"><span>Pokémon RL</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li>
          
  
  

  
    <span>Chapter 1: RL and the Pokémon Environment</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/the-loop/" class="">RL Quickstart</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/env-setup/" class="">Setting up the Environment</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Breaking Down Pokémon</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/breakdown/intro/" class="">Intro</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/breakdown/battling/" class="">Battling</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/breakdown/8badges/" class="">The 8 Badges</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/breakdown/field_interactions/" class="">Field Interactions and Exploration</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/breakdown/team_rocket/" class="">Team Rocket</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/breakdown/route/" class="">The &#34;Route&#34;</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-1/breakdown/risk_management/" class="">Risk Management</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Chapter 2: Observations, Rewards, and Policy</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-2/observations/" class="">Observations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-2/rewards/" class="">Rewards</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-2/policy/" class="">Policy</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Chapter 3: Building and Running the System</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-3/running/" class="active">Running</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-3/reading-asm/" class="">Reading RAM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-3/metrics/" class="">Metrics and Visualization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-3/swarm/" class="">The Swarm</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Chapter 4: Concluding Thoughts</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-4/results/" class="">Results</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/pokerl/docs/chapter-4/future/" class="">Future</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/pokerl/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Running</h3>

  <label for="toc-control">
    
    <img src="/pokerl/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#pokémon-is-cpu-bound">Pokémon is CPU Bound</a>
      <ul>
        <li><a href="#the-emulator">The Emulator</a></li>
        <li><a href="#collecting-screen-data">Collecting Screen Data</a></li>
      </ul>
    </li>
    <li><a href="#when-to-care-about-the-gpu">When to Care About the GPU</a></li>
    <li><a href="#observation-size-matters">Observation Size Matters</a>
      <ul>
        <li><a href="#compressing-data">Compressing Data</a></li>
      </ul>
    </li>
    <li><a href="#a-good-vectorized-env-is-worth-its-weight-in-gold">A Good Vectorized Env is Worth its Weight in Gold</a></li>
    <li><a href="#good-hyperparameters-can-mean-faster-training">Good Hyperparameters can mean faster training</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="actually-building-the-rl-system">
  Actually Building the RL System
  <a class="anchor" href="#actually-building-the-rl-system">#</a>
</h1>
<p>So I have a policy, observations, an environment and a reward. Now it&rsquo;s time to discuss the meat of the system and how I wrote it. Along the way, I&rsquo;ll provide relevant snippets of code and tricks I did to make my system run as fast as possible.</p>
<p>Before I begin though, I am obligated to give thanks to Joseph Suarez, the creator of PufferAI and PufferLib. Joseph graciously donated 4 machines to this effort. Each machine contained a NVIDIA 4090 GPU, Intel Core i9-14900K, 125 GB of RAM and 2TB of disk space. Before his contribution, I was paying $200/month using <a href="https://vast.ai/">vast.ai</a> for training with worse hardware.</p>
<p>Good hardware although not necessary, massively sped up training.</p>
<p>But what was more important than good hardware? Good software! I want to discuss some of the challenges of the Pokémon environment and mitigations I had in place for those challenges. In the end, I 10x’d the steps per second (sps) of training to a peak of 10000 sps with a lot of extra engineering effort. Potentially more effort than I put into everything I mentioned previously.</p>
<h2 id="pokémon-is-cpu-bound">
  Pokémon is CPU Bound
  <a class="anchor" href="#pok%c3%a9mon-is-cpu-bound">#</a>
</h2>
<h3 id="the-emulator">
  The Emulator
  <a class="anchor" href="#the-emulator">#</a>
</h3>
<p>Before I started working on the RL side of this project, it was commonly voiced in the Pokémon RL Discord that PyBoy slow. PyBoy happens to provide a very convenient interface for RL and is relatively well performant for Python. However, using an emulator comes with its downsides. Namely, PyBoy is emulating every instruction from the ROM. That means no compiler optimizations, no link time optimizations etc. I could have attempted to rewrite Pokémon in a modern language, but that would have been a Herculean effort on its own. Instead, PyBoy got faster.</p>
<p>A slow PyBoy <em>was</em> the case. But I’ve been in frequent communication with the creator of PyBoy for a while and we (mostly him) have put a lot of effort into improving PyBoy since late 2023. PyBoy has released a number of updates that have improved runtime speed and developer ergonomics dramatically including:</p>
<ul>
<li>Better usage of compiler optimization flags.</li>
<li>Better usage of Cython’s gil release options.</li>
<li>JIT compiling the ROM.</li>
<li>Data layout optimization.</li>
<li>The addition of hooks.</li>
</ul>
<p>Most of these changes are in PyBoy’s core. Hooks are a special addition that let me inject Python code at specified instructions. Although the context switch back to Python slows down execution, the less frequent RAM reads hooks allow have led to an overall speedup in Pokémon. However, even now, the environment still uses the majority of training time!</p>
<div style="text-align: center; ">
<p><img src="assets/flamegraph.png" alt="" /></p>
</div>
<h3 id="collecting-screen-data">
  Collecting Screen Data
  <a class="anchor" href="#collecting-screen-data">#</a>
</h3>
<p>With the working emulator, did I need to collect data <em>every</em> frame? Short answer, no. In fact, it is suboptimal to do so. Pokémon only uses action information sparingly. This is well documented in Peter Whidden’s video. In order to use PyBoy effectively:</p>
<ul>
<li>I render the game headless. No UI means less CPU time spent rendering the game.</li>
<li>For every action, I tick PyBoy 24 times and record the game screen on the <em>last</em> step.</li>
<li>I don’t collect information from memory every step.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_action_on_emulator</span>(self, action):
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>action_hist[action] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># press button then release after some steps</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># TODO: Add video saving logic</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>disable_ai_actions:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pyboy<span style="color:#f92672">.</span>send_input(VALID_ACTIONS[action])
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pyboy<span style="color:#f92672">.</span>send_input(VALID_RELEASE_ACTIONS[action], delay<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>pyboy<span style="color:#f92672">.</span>tick(self<span style="color:#f92672">.</span>action_freq <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, render<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># TODO: Split this function up. update_seen_coords should not be here!</span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>update_seen_coords()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>read_m(<span style="color:#e6db74">&#34;wJoyIgnore&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># DO NOT DELETE. Some animations require dialog navigation</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pyboy<span style="color:#f92672">.</span>button(<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pyboy<span style="color:#f92672">.</span>tick(self<span style="color:#f92672">.</span>action_freq, render<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># One last tick just in case</span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>pyboy<span style="color:#f92672">.</span>tick(<span style="color:#ae81ff">1</span>, render<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>If we look at the core functionality for running an action on the emulator, there is one small addition. Ticking while the agent does not have control. Waiting for control to return to the player removes certain levels of non-determinism. Most annoyingly, the extra animation when moving a boulder with strength.</p>
<h2 id="when-to-care-about-the-gpu">
  When to Care About the GPU
  <a class="anchor" href="#when-to-care-about-the-gpu">#</a>
</h2>
<p>Generating data on the CPU has generally been the bottleneck, but training and inference do occur and during the training loop of my RL system, I am not running the emulator. I’m running the policy on the GPU with PyTorch. There are still gains to be had from speeding up the GPU side of training, even if it didn’t give me 2x returns.</p>
<p>There are many avenues for speeding up training:</p>
<ul>
<li>Decrease the model size.</li>
<li>Decrease the data size.</li>
<li>Improve the GPU utilization.</li>
<li>Improve sample efficiency.</li>
</ul>
<p>There are some common techniques to improve the speedup. Some I contributed back to PufferLib (since early 2024 I have optimized pieces of PufferLib for a 2x speed up).  I achived a 30% GPU speed improvement on inference by using torch.compile improved the GPU utilization with <a href="https://pytorch.org/tutorials/intermediate/torch_compile_tutorial.html">torch.compile</a>. Torch compilation traces the execution graph of a PyTorch module and will create an optimized GPU execution graph.</p>
<p>The other major speed optimization in the training loop came from making sure I <a href="https://developer.nvidia.com/blog/how-optimize-data-transfers-cuda-cc/#pinned_host_memory">pinned memory</a> for any tensors I used on GPU. Pinning prevents an extra memory copy when moving data from the CPU host to the GPU device.</p>
<h2 id="observation-size-matters">
  Observation Size Matters
  <a class="anchor" href="#observation-size-matters">#</a>
</h2>
<p>After all that, the biggest bottleneck happened to be the data transfer of the observation. Not just from the CPU to GPU, but also from each agent back to the buffer holding all agent experiences for the current policy.</p>
<p>Remember the model is 40MB. However, model input for a ≈20k row batch is ≈450MB.</p>
<p>I looked into ways to decrease the memory size of the batch I sent to the GPU! Some techniques I used were really neat and I want to brag about them beyond choosing smaller data types, such as using a uint8 over a uint64 (1/8 smaller)</p>
<h3 id="compressing-data">
  Compressing Data
  <a class="anchor" href="#compressing-data">#</a>
</h3>
<p>The GameBoy playable area is 144x160 pixels. PyBoy always returns 4 channels, RGBA. However, GameBoy games are grayscale so I only need 1 channel.</p>
<p>&ndash;&gt; 1/4 reduction in screen data size or 92kB &ndash;&gt; ≈23kB</p>
<p>Additionally, as Peter Whidden showed, the agent doesn&rsquo;t need the <em>full</em> screen. Half resolution or downscaling the image to 72x80 pixels is fine.</p>
<p>&ndash;&gt; 1/4 reduction in screen data or 23kB &ndash;&gt; ≈6kB</p>
<p>I can go one step further. GameBoy’s color system is 2 bit. Every pixel takes 2 bits representing one of 4 values. Even though PyBoy does not return the dense layout of the game screen, I could recompress the data such that every 8 bits, that is 1 byte, represents 4 pixels? Then, I could decompress the data on the GPU which should be fast since GPUs are designed for massively parallel operations.</p>
<p>&ndash;&gt; Another 1/4 reduction in data size or 6kB &ndash;&gt; ≈2kB</p>
<p>And there I had a potential near 64x speed up in host&lt;-&gt;device communication. Now why does this work?</p>
<p>To unpack on the GPU, I store two buffers, a bit mask and a number of shifts. I shift the bytes then apply the bit mask and voila hyper parallel decoding for both the visited mask and the game screen.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Env</span>(gym<span style="color:#f92672">.</span>Env):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">collect_screen_data</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># (144, 160, 3)</span>
</span></span><span style="display:flex;"><span>        game_pixels_render <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>expand_dims(self<span style="color:#f92672">.</span>screen<span style="color:#f92672">.</span>ndarray[:, :, <span style="color:#ae81ff">1</span>], axis<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>reduce_res:
</span></span><span style="display:flex;"><span>            game_pixels_render <span style="color:#f92672">=</span> game_pixels_render[::<span style="color:#ae81ff">2</span>, ::<span style="color:#ae81ff">2</span>, :]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># game_pixels_render = skimage.measure.block_reduce(game_pixels_render, (2, 2, 1), np.min)</span>
</span></span><span style="display:flex;"><span>        game_pixels_render <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                np<span style="color:#f92672">.</span>digitize(
</span></span><span style="display:flex;"><span>                    game_pixels_render<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>)), PIXEL_VALUES, right<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                )<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;&lt;</span> np<span style="color:#f92672">.</span>array([<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>], dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>sum(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, game_pixels_render<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Policy</span>(nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>register_buffer(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;screen_buckets&#34;</span>, torch<span style="color:#f92672">.</span>tensor(PIXEL_VALUES, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>uint8), persistent<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>register_buffer(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;unpack_mask&#34;</span>,
</span></span><span style="display:flex;"><span>            torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x0C</span>, <span style="color:#ae81ff">0x03</span>], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>uint8),
</span></span><span style="display:flex;"><span>            persistent<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>register_buffer(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;unpack_shift&#34;</span>, torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>uint8), persistent<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unpack_screen_data</span>(self, screen: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>        screen <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>index_select(
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>screen_buckets,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            ((screen<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&amp;</span> self<span style="color:#f92672">.</span>unpack_mask) <span style="color:#f92672">&gt;&gt;</span> self<span style="color:#f92672">.</span>unpack_shift)<span style="color:#f92672">.</span>flatten()<span style="color:#f92672">.</span>int(),
</span></span><span style="display:flex;"><span>        )<span style="color:#f92672">.</span>reshape(restored_shape)
</span></span><span style="display:flex;"><span>        visited_mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>index_select(
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>linear_buckets,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            ((visited_mask<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&amp;</span> self<span style="color:#f92672">.</span>unpack_mask) <span style="color:#f92672">&gt;&gt;</span> self<span style="color:#f92672">.</span>unpack_shift)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>flatten()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>int(),
</span></span><span style="display:flex;"><span>        )<span style="color:#f92672">.</span>reshape(restored_shape)
</span></span></code></pre></div><p>This data technique also works for the events vector. Instead of representing every event flag as 1 byte, I sent the entire events vector to the GPU. Therefore 1 byte held 8 flags. On the GPU, and performed a similar shift and mask! Fast decoding of over 2000 event flags.</p>
<h2 id="a-good-vectorized-env-is-worth-its-weight-in-gold">
  A Good Vectorized Env is Worth its Weight in Gold
  <a class="anchor" href="#a-good-vectorized-env-is-worth-its-weight-in-gold">#</a>
</h2>
<p>In between the emulator and the model, I had the code managing the vectorized environment. Originally, I used the library Stable Baselines 3. It’s a great library for prototyping with RL, but it handles env vectorization suboptimally. SB3 will wait for all environments to finish their current actions before sending the next batch.</p>
<p>In early 2024, I adopted PufferLib from PufferAI. PufferLib provides an asynchronous vectorized environment implementation. My PufferLib-based implementation collects data from environments until enough examples have been collected. Once enough examples have been collected, a few epochs of training occurs.</p>
<h2 id="good-hyperparameters-can-mean-faster-training">
  Good Hyperparameters can mean faster training
  <a class="anchor" href="#good-hyperparameters-can-mean-faster-training">#</a>
</h2>
<p>The last dimension for a faster training experience isn’t making the overall iteration time faster, but improving sample efficiency. Once I had a game winning model, I spent over a month sweeping hyperparameter to find parameters that would produce a winning run in the fastest amount of time. Hyperparameters define any configurable part of the system. These are parameters that are not intended to be learned.</p>
<p>Most hyperparameter sweep libraries will optimize for a single metric, such as reward. I wanted to optimize for reward with a time penalty. <a href="https://github.com/imbue-ai/carbs">CARBS from Imbue</a> is a <em>cost-aware</em> hyperparameter sweep tool. With proper hyperparameters, I reduced a single training run (with scripting) from 2 days to 7 hours. A nearly 7x reduction in training time.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#pokémon-is-cpu-bound">Pokémon is CPU Bound</a>
      <ul>
        <li><a href="#the-emulator">The Emulator</a></li>
        <li><a href="#collecting-screen-data">Collecting Screen Data</a></li>
      </ul>
    </li>
    <li><a href="#when-to-care-about-the-gpu">When to Care About the GPU</a></li>
    <li><a href="#observation-size-matters">Observation Size Matters</a>
      <ul>
        <li><a href="#compressing-data">Compressing Data</a></li>
      </ul>
    </li>
    <li><a href="#a-good-vectorized-env-is-worth-its-weight-in-gold">A Good Vectorized Env is Worth its Weight in Gold</a></li>
    <li><a href="#good-hyperparameters-can-mean-faster-training">Good Hyperparameters can mean faster training</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












