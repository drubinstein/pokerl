[{"id":0,"href":"/pokerl/docs/chapter-1/the-loop/","title":"RL Quickstart","section":"Chapter 1: RL and the Pokémon Environment","content":" RL Quickstart # Before I focus on Pokémon, I\u0026rsquo;d like to start by giving a brief primer on Reinforcement Learning. Reinforcement Learning (RL) is a focus of study on how an agent should take actions in an environment in order to maximize a reward. This primer will not be exhaustive. I am writing it to set the framework for which I built my Pokémon training system.\nIn a typical RL framework, there will be 2 components.\nThe Environment - Represents the world context. The Agent - Responsible for generating actions to perform in the environment The agent contains a policy for generating an action given a state of the environment using a . The environment evaluates the action and returns an observation and a reward. These actions, observations and rewards can be used to update the agent\u0026rsquo;s policy.\nWhen building an RL system, I like to breakdown the problem into modeling the problem as\nthe goal the environment the observation the actions the reward the policy / the agent Tic Tac Toe # Let\u0026rsquo;s apply RL to Tic-Tac-Toe. RL does not need machine learning. A valid RL agent can be as simple as a look up table! For those who have never played Tic-Tac-Toe, Tic-Tac-Toe is a two player game where each player takes turns marking a single square in a 3x3 grid. The first player to have marked 3 squares making a horizontal, vertical or diagonal line wins. Let\u0026rsquo;s breakdown Tic-Tac-Toe in the framework above\nGoal # The goal of Tic-Tac-Toe is to win! After a player has achieved 3-in-a-row, the game will reset. We call this beginning of game to end of game period an episode.\nEnvironment # The environment is the Tic-Tac-Toe game itself. The environment will be responsible for performing actions on the grid, i.e., marking squares, ensuring invalid moves are not played and determining when the game has ended.\nObservation # The observation will be the current 3x3 grid represented as a 3x3 array.\nActions # The action will be a coordinate to play on the grid. For example [0, 0] will mean mark on the upper left hand corner. [2, 2] will mean mark the lower right hand corner.\nRewards # We can start with a reward of\n+1 if the player wins -1 if the player loses We can even be simpler and say +1 if the player wins, -1 if the player loses. The act of modifying the reward for a better system is known as reward shaping. If you make your reward simpler, you risk the agent never learning how to perform complex actions. If you make your reard complex, you risk the agent will never progress beyond immediate greedy actions.\nTraining the Policy # Now that we have created our Tic-Tac-Toe RL system, we can attempt to train a policy to be the best Tic-Tac-Toe player ever. At the start of training, the policy will play random moves, but as it obtains more experience, it will learn to exploit the reward function.\nFor Pokémon, I am going to breakdown the game similarly. Let\u0026rsquo;s dig in.\n"},{"id":1,"href":"/pokerl/docs/chapter-1/env-setup/","title":"Setting up the Environment","section":"Chapter 1: RL and the Pokémon Environment","content":" Setting up the Environment # When I start designing an RL system, I start with the environment. The Python library Gymnasium provides a fairly straightforward API which can be simplified into two functions: Reset and Step\nResets, Episodes and the Goal # Reset handles the initialization for a gameplay session also known as an “episode.”\nIn most video game DRL projects I\u0026rsquo;ve observed a reset will happen when an agent\nAchieves a major milestone, such as defeating a boss. Encounters a failure state, such as losing all their lives. Reaches a predefined time or action limit, such as 100 tetriminos in Tetris, Pokémon is in the realm of “long episodic RL.” Long episodes mean that the agent may not get large rewards for a very long time. If the agent only receives large rewards at the end of an episode, it may have trouble creating long term policies.\nImagine if in the Tic-Tac-Toe example, the grid was 100x100. That means the agent wouldn\u0026rsquo;t receive a reward for up to a max 5000 steps. Imagine having to plan out a 5000 step strategy. It\u0026rsquo;s not easy! Later, I\u0026rsquo;ll go over how I handled rewards for Pokémon\u0026rsquo;s long episodes.\nBased on prior work, I began with an episode being a fixed number of steps. Over time, I tried multiple additional strategies including dynamically increasing the number of steps per episode as the agent performed important milestones. However, I believe an episode should be the based on a goal or when the agent achieves an unrecoverable state (soft-lock), e.g., such as running out of money.\nWhat\u0026rsquo;s the goal of Pokémon I aimed to complete? To be the champion! Therefore, I came up with a compromise. I created “mini-episodes.” An episode would be the duration of an entire game. However, the agent\u0026rsquo;s state would periodically reset mid-episode, but the emulator state would not.\nSteps # Step handles actions meant for the environment and returns observations based on a taken action, any logging info and whether or not to reset the environment.\nOur step function for Pokémon can naively be written as:\nReceive a button press action Send the button press to the gameboy emulator Wait some frames for the action to have an effect on the environment Sample the environment Return data based on the sample And that’s really it. Once I had the game loop running in a Gymnasium Environment, I could begin to implement game-specific functionality.\n"},{"id":2,"href":"/pokerl/docs/chapter-1/breakdown/intro/","title":"Intro","section":"Breaking Down Pokémon","content":" Breaking Down Pokémon # Before going into observations, rewards and the policy, I believe studying the environment is higher priority. As I already said multiple times, Pokémon is a complex game with multiple tasks and puzzles that can be accomplished nonlinearly.\nOnce we have an understanding of the game and all its gotchas, we can engineer observations and rewards to accomplish all tasks.\nTo begin, I enumerated the game’s storyline objectives. These objectives may be a little more detailed than what you would read in an average walkthrough, but it was important to cover what’s required or risk the agent getting stuck. At a high level, beat Pokémon, you must:\nBeat the 8 Gym Leaders. Gym leaders are a form of video game “boss.” Acquire items to teach the moves CUT, STRENGTH, and, SURF. Field moves are abilities that can be used outside of battle to unlock a new area or make it easier to traverse an existing area. Acquire Pokémon that can learn the field moves CUT, STRENGTH, and SURF. Acquire any items required for field interactions. Like field moves, there are items that are required to unlock new areas. Teach available Pokémon the field moves CUT, STRENGTH, and SURF Use field moves or items for field interactions to remove any game blocking obstacles. Complete the Team Rocket storyline. Beat the 6 required rival battles Beat the Elite 4 and Champion Or, if we want to be more detailed\u0026hellip;\nflowchart TD AA(Acquire starter Pokémon from Prof. Oak) AA --\u003e AAA(Acquire Parcel from Viridian Mart) --\u003e AAAA(Deliver Parcel to Prof. Oak) AAAA --\u003e A(Defeat Brock) --\u003e B(Traverse Mt. Moon) B --\u003e C(Defeat Misty) B --\u003e D(Nugget Bridge) --\u003e E(Get the SS Anne ticket from Bill) --\u003e F(Defeat Cerulean Rocket Grunt) --\u003e G(Defeat Rival on the SS Anne) --\u003e H(Obtain HM01 - Cut from the Captain on the SS Anne) C --\u003e I C --\u003e J C --\u003e K C --\u003e M H --\u003e HH(Defeat Rocket grunt protecting Rocket Hideout) --\u003e HHH(Flip switch in Celadon Game Corner to unlock the Rocket Hideout) HHH --\u003e KK(Defeat Rocket grunt with Lift Key) --\u003e KKK(Obtain the Lift Key) --\u003e K(Defeat Giovanni in Rocket Hideout) K --\u003e LL(Collect the Silph Scope from Giovanni) --\u003e LLL(Use the Silph Scope on the ghost in Lavender Tower) LLL --\u003e L(Save Mr. Fuji at the top floor of Lavender Tower) H --\u003e I(Defeat Lt. Surge) H --\u003e J(Defeat Erika) H --\u003e MM(Obtain a drink from the vendeing machines at the top of Celadon Mart) MM --\u003e M(Deliver Drink to Saffron Guard) --\u003e O L --\u003e N(Obtain Pokéflute) L --\u003e OO(Defeat Rival 5 in Silph Co) --\u003e O(Defeat Giovanni in Silph Co) --\u003e P(Defeat Sabrina) N --\u003e Q(Use Pokéflute on at least one Snorlax) Q --\u003e R(Obtain HM03 - Surf from the Safari Zone) --\u003e T(Acquire the Secret Key from Pokémon Mansion) --\u003e U(Defeat Blaine) Q --\u003e V(Koga) --\u003e T Q --\u003e SS(Obtain the Gold Teeth from the Safari Zone) --\u003e S(Deliver the Gold Teeth to the old man in Fuchsia City to acquire HM04 - Strength) I --\u003e W(Defeat Giovanni in Viridian Gym) --\u003e X(Defeat Rival 6) --\u003e Y(Traverse Victory Road) J --\u003e W P --\u003e W U --\u003e W S --\u003e Y Y --\u003e Z(Defeat the Elite 4) --\u003e ZZ(Defeat the Champion) I broke down these objectives to understand what is and is not important for beating Pokémon Red.\n"},{"id":3,"href":"/pokerl/docs/chapter-1/breakdown/battling/","title":"Battling","section":"Breaking Down Pokémon","content":" Battling # Half of the previously mentioned objectives involve battling and winning against other trainers. However, I concluded that teaching battling is not required to make an agent capable of completing Pokémon with RL.\nThe Pokémon battle system is pretty straight forward. Pokémon is an advanced game of rock-paper-scissors. Pokémon have moves that can be used to either inflict status effects against other Pokémon, damage other Pokémon or boost their own abilities or self-heal. The strength of each move is affected by the strengths and weaknesses of each Pokémon relative to the move and overall stats. Moves are given priority based on a Pokémon\u0026rsquo;s SPEED stat or based on a move\u0026rsquo;s priority. Damage is based on the Pokémon\u0026rsquo;s ATTACK, SPECIAL and DEFENSE stats depending on the move. Additionally, moves can miss based on a move and Pokémon\u0026rsquo;s ACCURACY stats.\nDuring battles, the agent can additionally switch their current Pokémon in-battle or use items to heal their Pokémon.\nThere are two types of battles in Pokémon. The first type are wild battles where the agent will battle against a single Pokémon. Wild battles generally begin with a random encounter in grassy areas or dungeons. The second type are trainer battles. Trainer battles place the agent against a team of one or more Pokémon. Trainers have access to the same item and party switch actions the agent has.\nBattles end when all Pokémon on one side have fainted. Fainting is when a Pokémon\u0026rsquo;s health drops to zero. Additionally, during a wild battle, the agent has the option to run and leave the wild battle without penalty or catch the opposing Pokémon and have the opposing Pokémon join their party.\nIf the agent\u0026rsquo;s Pokémon knocks out the opposing Pokémon, they gain experience (EXP). With enough EXP, a Pokémon will level up. Levelling up provides a mechanism to increase the Pokémon\u0026rsquo;s stats. Levelling up to increase stats gives a mechanism to ignore worrying about battling. If the agent “grinds,” that is, let Pokémon level up or retry trainers infinite times, the agent will eventually win outside of a couple of very unlikely situations.\nConsequentially, I ignored creating a policy for battling and focused on providing suitable conditions for levelling up when needed.\n"},{"id":4,"href":"/pokerl/docs/chapter-1/breakdown/8badges/","title":"The 8 Badges","section":"Breaking Down Pokémon","content":" The 8 Badges # Next, I focused on what it takes to beat the 8 gym leaders. The gym leaders upon defeat, give the main character a “badge.” Badges either unlock the ability to use a taught field move or apply permanent stat modifiers to the agent’s party. Below is a table of the gym leaders of Pokémon, their types and what they unlock.\nGym Leader Type Reward Brock Rock - 12.5% ATTACK boost- Can use FLASH outside of battle Misty Water - Can use CUT outside of battle Lt. Surge Electric - 12.5% DEFENSE boost- Can use FLY outside of battle Erika Grass - Can use STRENGTH outside of battle Koga Poison - 12.5% SPEED boost- Can use SURF outside of battle Sabrina Psychic Blaine Fire -12.5% SPECIAL boost Giovanni Ground I emphasized 5 gym leaders. Why? Because these gym leaders can be accomplished in nearly any order. The vast majority of storyline events are gated by Misty, Erika, and Koga who give access to the field moves CUT, STRENGTH and SURF outside of battle. How to obtain these field moves will be discussed in a later section.\nSome gym leaders require solving puzzles or removing environmental guards.\nLt. Surge\u0026rsquo;s Gym Gimmick # To enter Lt. Surge’s gym you must remove a tree blocking the entrance to his gym with Cut.\nLt. Surge’s gym contains a button puzzle. To acquire the ability to battle Lt. Surge, you are given an array of trashcans. Two of the trashcans have a button that can be pressed. You must press the two buttons in a specific order. If you mess up, the buttons are randomly assigned to different trashcans.\nErika\u0026rsquo;s Gym Gimmick # To enter Erika\u0026rsquo;s gym you must remove a tree blocking the entrance to her gym with cut. In her gym, she will be guarded by multiple trainers you must defeat and more trees to cut. Notably, the sprite for the trees within the gym are different from the tree sprite outside the gym.\nKoga\u0026rsquo;s Gym Gimmick # Koga’s gym contains an easy maze made up of invisible barriers you have to traverse.\nSabrina\u0026rsquo;s Gym Gimmick # Sabrina’s gym can only be entered after completing the Team Rocket storyline. Her gym contains a teleporter maze. To get to Sabrina, you must find the teleporter that will transport you to her.\nBlaine\u0026rsquo;s Gym Gimmick # To enter Blaine’s gym the agent must first Surf to Cinnabar Island where the gym is located. Subsequently, the agent must acquire the “SECRET KEY” from the Pokémon Mansion next door to his gym Surf. To battle Blaine, the agent must complete a series of optional True/False quizzes. If the agent incorrectly answers, the agent battles a trainer.\nGiovanni\u0026rsquo;s Gym Gimmick # Giovanni’s gym is blocked until you beat all 7 prior gym leaders. Giovanni’s gym contains a maze puzzle with “spin tiles.”\nThe agent must be capable of solving all these tasks.\n"},{"id":5,"href":"/pokerl/docs/chapter-1/breakdown/field_interactions/","title":"Field Interactions and Exploration","section":"Breaking Down Pokémon","content":" Field Interactions and Exploration # As mentioned previously, field moves taught to Pokémon via “HMs” allow you to interact with the world. These HMs can only be taught to specific Pokémon.\nThe 5 field moves of Pokémon are\nHM01 - CUT HM02 - FLY HM03 - SURF HM04 - STRENGTH HM05 - FLASH Only CUT, SURF, and STRENGTH are required for game progression. Although useful, FLY and FLASH aren’t required. They only allow for faster game progression.\nObtaining HM01 - CUT # To acquire HM01, the agent must:\nAcquire the SS Anne ticket from Bill north of Cerulean City. Board the SS Anne and battle their rival Help the captain of the ship. The captain will reward the agent with the item HM01.\nObtaining HM03 - SURF # To obtain SURF, the agent must reach the end of the Safari Zone in less than 500 steps. At the end, the Safari Zone Warden will reward the player with HM03\nObtaining HM04 - Strength # To obtain STRENGTH, the agent must:\nFind the GOLD TEETH in the Safari Zone. Bring the GOLD TEETH to the old man NPC in Fuchsia City The old man will then reward the agent with the item HM04\nUsing an HM # Teaching and using an HM requires a minimum of 17 actions along with a Pokémon in the agent\u0026rsquo;s party that is capable of learning the HM. 17+ actions are hard enough to give the agent context for. Incentivizing the agent to have HM capable party members when it is playing Pokémon for the first time without a guide is an even harder task!\nObtaining and Using the Pokéflute # Along with field moves, the agent will need to use the item Pokéflute for one field interaction. Pokéflute can remove two roadblocks (at least one is required) so the agent can gain access to Fuchsia City.\nHowever, using Pokéflute is very similar to using an HM. A level of convenience that I will use when ensuring the agent can perform the action.\n"},{"id":6,"href":"/pokerl/docs/chapter-1/breakdown/team_rocket/","title":"Team Rocket","section":"Breaking Down Pokémon","content":" Team Rocket Storyline # Beyond the gym battles and field moves, there are mandatory quests involving encounters with the antagonist group, Team Rocket. These events require defeating trainers, obtaining special items, and solving in-game puzzles. Thankfully, these quests must be accomplished in a linear order. For completeness, hare are all the tasks required to to complete the Rocket storyline:\nDefeat the rockets blocking the exit to Mt. Moon (post Brock). Defeat the rocket at the end of Nugget Bridge north of Cerulean City. Defeat the rocket at the exit of Cerulean City. Defeat the rocket guard in the Celadon City Casino. Press the poster switch the Celadon City Casino Rocket guard is guarding and enter the Rocket hideout. Solve the Rocket hideout maze puzzle on BF3 to get to BF4. Beat the Rocket grunt in BF4. Pick up the dropped elevator key from the BF4 Rocket Grunt. Solve the maze puzzle on BF2. Use the elevator key to enter the elevator on BF2. Go to BF4 using the elevator key. Beat Giovanni in Rocket Hideout. Pick up the Silph Scope Giovanni drops. Go to the Pokémon Tower in Lavender Town. Use the Silph Scope to defeat the ghost waiting at the staircase to the second-to-top floor of Lavender Tower. Save Mr. Fuji at the top of Lavender Tower . Obtain a drink from the vending machine of Celadon City (can be done any time before this). Give a drink to one of the 4 Saffron City gate guards (can be done any time after obtaining the drink). Find the card key in Silph Co in Saffron City. Defeat Giovanni in Silph Co. It’s a lot of tasks. Unlike the gym leaders, the difficulty of the Team Rocket puzzles are highly variable, but brute-forceable. From these quests, I concluded the agent needed a desire to either explore the whole world or spend extra time building a policy capable of reading and interpreting text. I decided to focus on the former.\n"},{"id":7,"href":"/pokerl/docs/chapter-1/breakdown/route/","title":"The \"Route\"","section":"Breaking Down Pokémon","content":" Defining a \u0026ldquo;Route\u0026rdquo; # For the agent to complete all objectives, I wanted to simplify the number of game as much as possible to maximizing the likelihood of success. To limit non-determinism, I started the agent after the \u0026ldquo;Parcel Delivery\u0026rdquo; event. Starting the agent with a specific Pokémon would guarantee later stages of the game would be possible. Given the previous breakdown, here’s the route I wanted the agent to learn:\nStart with Bulbasaur or Charmander to guarantee a Pokémon who can use CUT. Defeat Brock. In any order: Defeat Misty. Acquire HM01 and teach CUT to Bulbasaur. In almost any order: Defeat gyms 3-7. Acquire HM03 and HM04. Complete the Team Rocket Storyline. Acquire the gift Lapras in Silph Co and teach the Lapras Surf and Strength. Defeat Gym 8. Defeat the 6th rival battle. Defeat the Elite 4 + Champion. "},{"id":8,"href":"/pokerl/docs/chapter-1/breakdown/risk_management/","title":"Risk Management","section":"Breaking Down Pokémon","content":" Risk Management # Even though I simplified the game, I still needed risk mitigation. Pokémon contains numerous game ending risks including:\nPermanently losing vital Pokémon Catching Pokémon and not having enough space for the Lapras or any other Pokémon that can learn Surf Item management. If the agent obtains too many items, then there may not be enough room for key items Money management. It is possible to soft-lock if you cannot obtain any more money at the time the Safari Zone objectives need to be completed. Only having Pokémon with non-damaging moves. I’d like to emphasize again that none of these issues require teaching the agent how to best Pokémon battles.\nScripting vs. Emergence # To handle these risks and difficulties, I split agent behavior into two classes:\nScripted: Meaning actions taken by the agent not controlled by the policy. Emergent: Allowing the agent to discover its own strategies. Ideally, no scripted behavior would be needed. However, I needed scripts. I aimed to only script behaviors that require human intuition or tasks that are not really a core part of Pokémon. These included.\nItem management - the agent will toss all non-key items if the agent fills their inventory. Money management - the agent will have infinite money. Solving puzzles that require Strength. Blocking the Indigo Plateau exit at the end of the game. To make development easier, I wrote scripts to remove the following complexity and speed up development. These scripts can disabled for a successful run, but were invaluable during development. They included\nTeaching HMs. Using HMs outside of battle. Using Pokéflute. Maxxing the Pokémon’s stats. Automatic insertion of drinks for the Saffron guards if the agent entered the Celadon Mart. Automating elevator usage. If an agent entered an elevator, the elevator would go to the next floor modulo number of floors. Disabling wild battles to simplify dungeons. "}]