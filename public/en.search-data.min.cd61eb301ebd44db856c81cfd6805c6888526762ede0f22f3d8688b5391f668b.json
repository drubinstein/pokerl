[{"id":0,"href":"/pokerl/docs/chapter-1/the-loop/","title":"RL Quickstart","section":"Chapter 1: Mapping Pokémon to RL","content":" RL Quickstart # Before I focus on Pokémon, I\u0026rsquo;d like to start by giving a brief primer on Reinforcement Learning. Reinforcement Learning (RL) is a focus of study on how an agent should take actions in an environment in order to maximize a reward. This primer will not be exhaustive. I am writing it to set the framework for which I built my Pokémon training system.\nIn a typical RL framework, there will be 2 components.\nThe Environment - Represents the world context. The Agent - Responsible for generating actions to perform in the environment The agent contains a policy for generating an action given a state of the environment using a . The environment evaluates the action and returns an observation and a reward. These actions, observations and rewards can be used to update the agent\u0026rsquo;s policy.\nWhen building an RL system, I like to breakdown the problem into modeling the problem as\nthe goal the environment the observation the actions the reward the policy / the agent Tic Tac Toe # Let\u0026rsquo;s apply RL to Tic-Tac-Toe. RL does not need machine learning. A valid RL agent can be as simple as a look up table! For those who have never played Tic-Tac-Toe, Tic-Tac-Toe is a two player game where each player takes turns marking a single square in a 3x3 grid. The first player to have marked 3 squares making a horizontal, vertical or diagonal line wins. Let\u0026rsquo;s breakdown Tic-Tac-Toe in the framework above\nGoal # The goal of Tic-Tac-Toe is to win! After a player has achieved 3-in-a-row, the game will reset. We call this beginning of game to end of game period an episode.\nEnvironment # The environment is the Tic-Tac-Toe game itself. The environment will be responsible for performing actions on the grid, i.e., marking squares, ensuring invalid moves are not played and determining when the game has ended.\nObservation # The observation will be the current 3x3 grid represented as a 3x3 array.\nActions # The action will be a coordinate to play on the grid. For example [0, 0] will mean mark on the upper left hand corner. [2, 2] will mean mark the lower right hand corner.\nRewards # We can start with a reward of\n+1 if the player wins -1 if the player loses We can even be simpler and say +1 if the player wins, -1 if the player loses. The act of modifying the reward for a better system is known as reward shaping. If you make your reward simpler, you risk the agent never learning how to perform complex actions. If you make your reard complex, you risk the agent will never progress beyond immediate greedy actions.\nTraining the Policy # Now that we have created our Tic-Tac-Toe RL system, we can attempt to train a policy to be the best Tic-Tac-Toe player ever. At the start of training, the policy will play random moves, but as it obtains more experience, it will learn to exploit the reward function.\nFor Pokémon, I am going to breakdown the game similarly. Let\u0026rsquo;s dig in.\n"},{"id":1,"href":"/pokerl/docs/chapter-1/env-setup/","title":"Setting up the Environment","section":"Chapter 1: Mapping Pokémon to RL","content":" Setting up the Environment # When I start designing an RL system, I start with the environment. The Python library Gymnasium provides a fairly straightforward API which can be simplified into two functions: Reset and Step\nResets, Episodes and the Goal # Reset handles the initialization for a gameplay session also known as an “episode.”\nIn most video game DRL projects I\u0026rsquo;ve observed a reset will happen when an agent\nAchieves a major milestone, such as defeating a boss. Encounters a failure state, such as losing all their lives. Reaches a predefined time or action limit, such as 100 tetriminos in Tetris, Pokémon is in the realm of “long episodic RL.” Long episodes mean that the agent may not get large rewards for a very long time. If the agent only receives large rewards at the end of an episode, it may have trouble creating long term policies.\nImagine if in the Tic-Tac-Toe example, the grid was 100x100. That means the agent wouldn\u0026rsquo;t receive a reward for up to a max 5000 steps. Imagine having to plan out a 5000 step strategy. It\u0026rsquo;s not easy! Later, I\u0026rsquo;ll go over how I handled rewards for Pokémon\u0026rsquo;s long episodes.\nBased on prior work, I began with an episode being a fixed number of steps. Over time, I tried multiple additional strategies including dynamically increasing the number of steps per episode as the agent performed important milestones. However, I believe an episode should be the based on a goal or when the agent achieves an unrecoverable state (soft-lock), e.g., such as running out of money.\nWhat\u0026rsquo;s the goal of Pokémon I aimed to complete? To be the champion! Therefore, I came up with a compromise. I created “mini-episodes.” An episode would be the duration of an entire game. However, the agent\u0026rsquo;s state would periodically reset mid-episode, but the emulator state would not.\nSteps # Step handles actions meant for the environment and returns observations based on a taken action, any logging info and whether or not to reset the environment.\nOur step function for Pokémon can naively be written as:\nReceive a button press action Send the button press to the gameboy emulator Wait some frames for the action to have an effect on the environment Sample the environment Return data based on the sample And that’s really it. Once I had the game loop running in a Gymnasium Environment, I could begin to implement game-specific functionality.\n"},{"id":2,"href":"/pokerl/docs/chapter-1/Pokémon-breakdown/","title":"Breaking Down Pokémon","section":"Chapter 1: Mapping Pokémon to RL","content":" Breaking Down Pokémon # Before going into observations, rewards and the policy, I believe studying the environment is higher priority. As I already said multiple times, Pokémon is a complex game with multiple tasks and puzzles that can be accomplished nonlinearly.\nOnce we have an understanding of the game and all its gotchas, we can engineer observations and rewards to accomplish all tasks.\nTo begin, I enumerated the game’s storyline objectives. These objectives may be a little more detailed than what you would read in an average walkthrough, but it was important to cover what’s required or risk the agent getting stuck. At a high level, beat Pokémon, you must:\nBeat the 8 Gym Leaders. Gym leaders are a form of video game “boss.” Acquire items to teach the moves CUT, STRENGTH, and, SURF. Field moves are abilities that can be used outside of battle to unlock a new area or make it easier to traverse an existing area. Acquire Pokémon that can learn the field moves CUT, STRENGTH, and SURF. Acquire any items required for field interactions. Like field moves, there are items that are required to unlock new areas. Teach available Pokémon the field moves CUT, STRENGTH, and SURF Use field moves or items for field interactions to remove any game blocking obstacles. Complete the Team Rocket storyline. Beat the 6 required rival battles Beat the Elite 4 and Champion If we want to be more detailed\u0026hellip;\nflowchart TD A(Defeat Brock) --\u0026gt; B(Traverse Mt. Moon) B --\u0026gt; C(Defeat Misty) B --\u0026gt; D(Nugget Bridge) --\u0026gt; E(Get the SS Anne ticket from Bill) --\u0026gt; F(Defeat Cerulean Rocket Grunt) --\u0026gt; G(Defeat Rival on the SS Anne) --\u0026gt; H(Obtain HM01 - Cut from the Captain on the SS Anne) C --\u0026gt; I C --\u0026gt; J C --\u0026gt; K C --\u0026gt; M H --\u0026gt; HH(Defeat Rocket grunt protecting Rocket Hideout) --\u0026gt; HHH(Flip switch in Celadon Game Corner to unlock the Rocket Hideout) HHH --\u0026gt; KK(Defeat Rocket grunt with Lift Key) --\u0026gt; KKK(Obtain the Lift Key) --\u0026gt; K(Defeat Giovanni in Rocket Hideout) K --\u0026gt; LL(Collect the Silph Scope from Giovanni) --\u0026gt; LLL(Use the Silph Scope on the ghost in Lavender Tower) LLL --\u0026gt; L(Save Mr. Fuji at the top floor of Lavender Tower) H --\u0026gt; I(Defeat Lt. Surge) H --\u0026gt; J(Defeat Erika) H --\u0026gt; MM(Obtain a drink from the vendeing machines at the top of Celadon Mart) MM --\u0026gt; M(Deliver Drink to Saffron Guard) --\u0026gt; O L --\u0026gt; N(Obtain Pokéflute) L --\u0026gt; OO(Defeat Rival 5 in Silph Co) --\u0026gt; O(Defeat Giovanni in Silph Co) --\u0026gt; P(Defeat Sabrina) N --\u0026gt; Q(Use Pokéflute on at least one Snorlax) Q --\u0026gt; R(Obtain HM04 - Surf from the Safari Zone) --\u0026gt; T(Acquire the Secret Key from Pokémon Mansion) --\u0026gt; U(Defeat Blaine) Q --\u0026gt; V(Koga) --\u0026gt; T Q --\u0026gt; SS(Obtain the Gold Teeth from the Safari Zone) --\u0026gt; S(Deliver the Gold Teeth to the old man in Fuchsia City to acquire HM03 - Strength) I --\u0026gt; W(Defeat Giovanni in Viridian Gym) --\u0026gt; X(Defeat Rival 6) --\u0026gt; Y(Traverse Victory Road) J --\u0026gt; W P --\u0026gt; W U --\u0026gt; W S --\u0026gt; Y Y --\u0026gt; Z(Defeat the Elite 4) --\u0026gt; ZZ(Defeat the Champion) I then broke down these objectives to understand what is and is not important for beating Pokémon.\nBattling # Half of the previously mentioned objectives involve battling and winning against other trainers. However, I concluded that teaching battling is not required to make an agent capable of completing Pokémon with RL.\nThe Pokémon battle system is pretty straight forward. Pokémon is an advanced game of rock-paper-scissors. Pokémon have moves that can be used to either inflict status effects against other Pokémon, damage other Pokémon or boost their own abilities or self-heal. The strength of each move is affected by the strengths and weaknesses of each Pokémon relative to the move and overall stats. Moves are given priority based on a Pokémon\u0026rsquo;s SPEED stat or based on a move\u0026rsquo;s priority. Damage is based on the Pokémon\u0026rsquo;s ATTACK, SPECIAL and DEFENSE stats depending on the move. Additionally, moves can miss based on a move and Pokémon\u0026rsquo;s ACCURACY stats.\nDuring battles, the agent can additionally switch their current Pokémon in-battle or use items to heal their Pokémon.\nThere are two types of battles in Pokémon. The first type are wild battles where the agent will battle against a single Pokémon. Wild battles generally begin with a random encounter in grassy areas or dungeons. The second type are trainer battles. Trainer battles place the agent against a team of one or more Pokémon. Trainers have access to the same item and party switch actions the agent has.\nBattles end when all Pokémon on one side have fainted. Fainting is when a Pokémon\u0026rsquo;s health drops to zero. Additionally, during a wild battle, the agent has the option to run and leave the wild battle without penalty or catch the opposing Pokémon and have the opposing Pokémon join their party.\nIf the agent\u0026rsquo;s Pokémon knocks out the opposing Pokémon, they gain experience (EXP). With enough EXP, a Pokémon will level up. Levelling up provides a mechanism to increase the Pokémon\u0026rsquo;s stats. Levelling up to increase stats gives a mechanism to ignore worrying about battling. If the agent “grinds,” that is, let Pokémon level up or retry trainers infinite times, the agent will eventually win outside of a couple of very unlikely situations.\nConsequentially, I ignored creating a policy for battling and focused on providing suitable conditions for levelling up when needed.\nThe 8 Badges # Next, I focused on what it takes to beat the 8 gym leaders. The gym leaders upon defeat, give the main character a “badge.” Badges either unlock the ability to use a taught field move or apply permanent stat modifiers to the agent’s party. Below is a table of the gym leaders of Pokémon, their types and what they unlock.\nBrock Misty Lt. Surge Erika Koga Sabrina Blaine Giovanni I emphasized 5 gym leaders. Why? Because these gym leaders can be accomplished in nearly any order. The vast majority of storyline events are gated by Misty, Erika, and Koga who give access to field moves outside of battle. How to obtain these field moves will be discussed in a later section.\nSome gym leaders require solving puzzles or removing environmental guards.\nTo enter Lt. Surge’s or Erika’s gym you must remove a tree blocking the entrance to their gyms with Cut.\nLt. Surge’s gym contains a difficult puzzle that resets if you get one answer wrong.\nKoga’s gym contains an easy maze made up of invisible barriers you have to traverse.\nSabrina’s gym can only be entered after completing the Team Rocket storyline and uses a maze puzzle of teleporters.\nGetting into Blaine’s gym requires obtaining the “SECRET KEY” from the building next door to his gym and the ability to use Surf. Blaine’s gym requires completing a series of optional pass/fail quizzes.\nAnd Giovanni’s gym is blocked until you beat all 7 prior gym leaders. Giovanni’s gym contains a maze puzzle with “spin tiles”\nThe agent must be capable of solving all these tasks.\nField Interactions and Exploration # Now I knew success hinged on obtaining and teaching specific moves or obtaining key items. As mentioned previously, these moves or “HMs” allow you to interact with the world. These HMs can only be taught to specific Pokémon.\nThe 5 field moves of Pokémon are\nCUT FLY SURF STRENGTH FLASH Only Cut, Surf and Strength are required for game progression. Although useful, fly and flash aren’t required. They only allow for faster game progression.\nCut is obtained by\nObtaining the SS Anne ticket from Bill north of Cerulean City Using the SS Anne ticket to board the SS Anne Rubbing the captain’s back on the SS Anne Surf is obtained by getting to the end of the Safari Zone in less than 500 steps\nStrength is obtained by\nFinding the GOLD TEETH in the Safari Zone Giving the GOLD TEETH to the old man in Fuchsia City Teaching and using an HM requires a minimum of 17 actions\nI needed to incentivize both teaching moves and using them. I also needed to ensure that the agent would have the Pokémon necessary for learning these HMs.\nAdditionally, the agents require the Pokéflute, an item that must be used to remove at least one roadblock.\nThankfully, using Pokéflute required a similar level of map navigation as using an HM.\nTeam Rocket Storyline # Beyond the gym battles and field moves, there are mandatory quests involving encounters with the antagonist group, Team Rocket. These events require defeating certain trainers, obtaining special items, or solving in-game puzzles. Thankfully, these quests must be accomplished in a linear order. For completeness, hare are all the tasks required to to complete the Rocket storyline:\nDefeat the rockets blocking the exit to Mt. Moon (post Brock) Defeat the rocket at the end of Nugget Bridge north of Cerulean City Defeat the rocket at the exit of Cerulean City Defeat the rocket guard in the Celadon city casino Press the poster switch the Celadon City Casino Rocket guard is guarding and enter the Rocket hideout Solve the Rocket hideout maze puzzle on BF3 to get to BF4 Beat the Rocket grunt in BF4 Pick up the dropped elevator key from the BF4 Rocket Grunt Solve the maze puzzle on BF2 Use the elevator key to enter the elevator on BF2 Go to BF4 using the elevator key Beat Giovanni in Rocket Hideout Pick up the Silph Scope Giovanni drops Go to the Pokémon Tower in Lavender Town Use the Silph Scope to defeat the ghost Marowak waiting at the staircase to the top floor of Lavender Tower Save Mr. Fuji at the top of Lavender Tower Obtain a drink from the vending machine of Celadon City (can be done any time before this) Give a drink to one of the 4 Saffron City gate guards (can be done any time after obtaining the drink) Find the card key in Silph Co in Saffron City Defeat Giovanni in Silph Co It’s…uh a lot of tasks. Unlike the gym leaders, the difficulty of the Team Rocket puzzles are highly variable, but brute-forceable. From these quests, I concluded the agent needed a desire to either explore the whole world or spend extra time building a policy capable of reading and interpreting text. I decided to focus on the former.\nDefining the \u0026ldquo;Route\u0026rdquo; # Additionally, for the agent to complete all objectives, I wanted to simplify the number of game possibilities as much as possible thereby maximizing the likelihood of success. Given the previous breakdown, here’s the route I aimed to train the agent to perform:\nStart with Bulbasaur or Charmander to guarantee a Pokémon who can use Cut. Finding Pokémon to learn other HMs can be guaranteed in some way. Beat Brock In any order: Beat Misty Get Cut and teach cut to Bulbasaur In almost any order: Beat gyms 3-7 Get Surf and Strength from the Safari Zone Beat the Team Rocket Storyline Obtain the free Lapras in Silph Co and teach it Surf and Strength Beat Gym 8 Beat the 6th rival battle And finally\nBeat the Elite 4 + Champion Risk Management # Even though I’ve simplified the game, I still needed risk mitigation. Pokémon contains numerous game ending risks including:\nPermanently losing vital Pokémon Catching Pokémon and not having enough space for the Lapras or any other Pokémon that can learn Surf Item management. If the agent obtains too many items, then there may not be enough room for key items Money management. It is possible to soft lock if you cannot obtain any more money at the time the Safari Zone objectives need to be completed. Only having Pokémon with non-damaging moves. I’d like to emphasize again that none of these issues require teaching the agent how to best Pokémon battles.\nScripting vs. Emergence # To handle these risks and difficulties, I split agent behavior into two classes:\nScripted: Meaning actions taken by the agent not controlled by the policy. Emergent: Allowing the agent to discover its own strategies. Ideally, no scripted behavior would be needed. However, I needed scripts. I aimed to only script behaviors that require human intuition Or tasks that are not really a core part of Pokémon. These included\nItem management - the agent will toss all non-key items if the agent fills their inventory Money management - the agent will have infinite money Solving puzzles that require Strength Blocking the Indigo Plateau exit at the end of the game To make development easier, I took the time to add scripts to remove the following complexity and speed up development. These scripts were disabled for the final run, but were invaluable during development. They included\nTeaching HMs Using HMs outside of battle Using Pokéflute Maxxing the Pokémon’s stats Automatic insertion of some important key items Automating elevator usage Disabling wild battles "}]